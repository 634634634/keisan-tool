<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>納品金額計算ツール</title>
    <link rel="stylesheet" href="style.css">
    <!-- [追加] パスワード認証スクリプト -->
    <script src="auth.js"></script>
    <!-- [追加] 初期データを読み込む -->
    <script src="initial-data.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>納品金額計算</h1>
            <nav>
                <a href="data.html">データ管理へ</a>
                <a href="list.html">保存済み一覧へ</a>
            </nav>
        </header>

        <div class="card">
            <h2>1. 得意先の選択</h2>
            <!-- [変更] 検索ボックスと自前の候補リストに変更 -->
            <div class="search-container">
                <input type="text" id="customer-search" placeholder="得意先名で検索または選択" autocomplete="off">
                <div id="customer-suggestions" class="suggestions-list"></div>
            </div>
        </div>

        <div class="card">
            <h2>2. 数量の入力</h2>
            <table id="product-table">
                <thead>
                    <tr>
                        <th>商品名</th>
                        <th>数量</th>
                        <th>単価</th>
                        <th>小計</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 商品リストはここに動的に生成されます -->
                </tbody>
            </table>
        </div>

        <!-- [追加] 入力内容の確認セクション -->
        <div class="card" id="summary-card" style="display: none;">
            <h2>入力内容の確認</h2>
            <table id="summary-table">
                <thead>
                    <tr>
                        <th>商品名</th>
                        <th>数量</th>
                        <th>単価</th>
                        <th>小計</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 数量が入力された商品がここに表示されます -->
                </tbody>
            </table>
        </div>

        <div class="card">
            <!-- 合計金額の表示を非表示にしました -->
            <div class="total-summary" style="display: none;"></div>
            <span id="subtotal" style="display: none;"></span><span id="tax" style="display: none;"></span><span id="grand-total" style="display: none;"></span>
            <button onclick="saveInvoice()">この内容で保存する</button>
            <p id="save-status" class="status-message"></p>
        </div>
    </div>

    <script>
        // ページ読み込み時の初期化処理
        document.addEventListener('DOMContentLoaded', () => {
            // --- 定数 ---
            const PRODUCT_DATA_KEY = 'productMasterData'; // [修正] 定数宣言を修正
            const CUSTOMER_SETTINGS_KEY = 'customerSettingsData';
            const INVOICE_KEY = 'savedInvoices';
            const CUSTOMER_USAGE_KEY = 'customerUsageFrequency';
            const DEFAULT_SETTINGS = { show_tax: true, group_size: 6, show_cost: false, tax_method: 'round' };

            // --- グローバル変数 ---
            let masterData = {};
            let customerSettings = {};

            // --- DOM要素の取得 ---
            const searchInput = document.getElementById('customer-search');
            const suggestionsContainer = document.getElementById('customer-suggestions');
            const productTable = document.getElementById('product-table');
            const productTbody = productTable.querySelector('tbody');
            const summaryCard = document.getElementById('summary-card');
            const summaryTable = document.getElementById('summary-table');
            const summaryTbody = summaryTable.querySelector('tbody');
            const subtotalEl = document.getElementById('subtotal');
            const taxEl = document.getElementById('tax');
            const grandTotalEl = document.getElementById('grand-total');
            const saveButton = document.querySelector('button[onclick="saveInvoice()"]');
            const saveStatusEl = document.getElementById('save-status');

            // --- ヘルパー関数 ---
            const formatCurrency = (num) => {
                if (num < 0) return `▲${Math.abs(num).toLocaleString()}円`;
                return `${num.toLocaleString()}円`;
            };

            const calculateTax = (amount, method) => {
                const tax = amount * 0.08;
                if (method === 'floor') {
                    return Math.floor(tax);
                }
                if (method === 'ceil') {
                    return Math.ceil(tax);
                }
                // デフォルトは 'round' (四捨五入)
                return Math.round(tax);
            };

            const getTableHeaderHTML = (showCost) => {
                let headerHtml = '<tr><th class="col-name">商品名</th><th class="col-qty">数量</th><th class="col-price">単価</th><th class="col-subtotal">小計</th>';
                if (showCost) {
                    headerHtml += '<th class="col-cost-price">売原価</th><th class="col-cost-subtotal">原価小計</th>';
                }
                return headerHtml + '</tr>';
            };

            const updateCustomerUsage = (customerName) => {
                const usage = JSON.parse(localStorage.getItem(CUSTOMER_USAGE_KEY)) || {};
                usage[customerName] = (usage[customerName] || 0) + 1;
                localStorage.setItem(CUSTOMER_USAGE_KEY, JSON.stringify(usage));
            };

            // --- データ処理関数 ---
            const getCalculationData = () => {
                const itemsWithQuantity = [];
                let totalSubtotal = 0;

                document.querySelectorAll('#product-table tbody tr').forEach(row => {
                    const input = row.querySelector('.quantity');
                    const quantity = parseFloat(input.value) || 0;
                    
                    if (quantity !== 0) {
                        const price = parseFloat(input.dataset.price);
                        const cost = parseFloat(input.dataset.cost);
                        itemsWithQuantity.push({
                            productName: row.querySelector('.col-name').textContent,
                            quantity,
                            price,
                            cost,
                            lineTotal: quantity * price,
                            costLineTotal: quantity * cost,
                        });
                    }
                    // 行の小計はリアルタイムで更新
                    const lineTotal = quantity * (parseFloat(input.dataset.price) || 0);
                    totalSubtotal += lineTotal;
                });
                return { itemsWithQuantity, totalSubtotal };
            };

            const updateRowTotals = () => {
                document.querySelectorAll('#product-table tbody tr').forEach(row => {
                    const input = row.querySelector('.quantity');
                    const quantity = parseFloat(input.value) || 0;
                    row.querySelector('.line-total').textContent = formatCurrency(quantity * (parseFloat(input.dataset.price) || 0));
                    if (row.querySelector('.cost-line-total')) {
                        row.querySelector('.cost-line-total').textContent = formatCurrency(quantity * (parseFloat(input.dataset.cost) || 0));
                    }
                });
            };

            // --- 描画関数 ---
            const renderProductList = () => {
                const customer = searchInput.value;
                const settings = customerSettings[customer] || DEFAULT_SETTINGS;

                productTable.classList.toggle('show-cost', settings.show_cost);
                productTable.querySelector('thead').innerHTML = getTableHeaderHTML(settings.show_cost);
                
                productTbody.innerHTML = '';
                if (!customer || !masterData[customer]) {
                    updateAllCalculations();
                    return;
                }

                masterData[customer].forEach(product => {
                    const tr = document.createElement('tr');

                    const nameTd = document.createElement('td');
                    nameTd.className = 'col-name';
                    nameTd.textContent = product.name;

                    const qtyTd = document.createElement('td');
                    qtyTd.className = 'col-qty';
                    const qtyInput = document.createElement('input');
                    qtyInput.type = 'number';
                    qtyInput.className = 'quantity';
                    qtyInput.dataset.price = product.price;
                    qtyInput.dataset.cost = product.cost || 0;
                    qtyTd.appendChild(qtyInput);

                    tr.appendChild(nameTd);
                    tr.appendChild(qtyTd);
                    tr.insertAdjacentHTML('beforeend', `<td class="col-price price">${formatCurrency(product.price)}</td><td class="col-subtotal line-total">0円</td>`);

                    if (settings.show_cost) {
                        tr.insertAdjacentHTML('beforeend', `<td class="col-cost-price price">${formatCurrency(product.cost || 0)}</td><td class="col-cost-subtotal cost-line-total">0円</td>`);
                    }
                    productTbody.appendChild(tr);
                });
                updateAllCalculations();
                if (customer) updateCustomerUsage(customer);
            };

            const renderSummary = (items, subtotal) => {
                const customer = searchInput.value;
                const settings = customerSettings[customer] || DEFAULT_SETTINGS;

                // 確認セクションの表示/非表示
                if (items.length > 0) {
                    summaryCard.style.display = 'block';
                    summaryTable.classList.toggle('show-cost', settings.show_cost);
                    summaryTable.querySelector('thead').innerHTML = getTableHeaderHTML(settings.show_cost);
                    
                    summaryTbody.innerHTML = ''; // 既存の表示をクリア
                    let totalTax = 0; // [修正] 合計消費税をここで初期化
                    let groupSubtotal = 0; // グループごとの小計
                    let groupCostSubtotal = 0; // グループごとの原価小計

                    items.forEach((item, index) => {
                        groupSubtotal += item.lineTotal;
                        if (settings.show_cost) groupCostSubtotal += item.costLineTotal;

                        const itemRow = summaryTbody.insertRow();
                        // [セキュリティ修正] innerHTMLの使用を避け、textContentとinsertAdjacentHTMLを使い分ける
                        const nameCell = itemRow.insertCell();
                        nameCell.className = 'col-name';
                        nameCell.textContent = item.productName;
                        itemRow.insertAdjacentHTML('beforeend', `
                            <td class="col-qty">${item.quantity < 0 ? '▲' + Math.abs(item.quantity) : item.quantity}</td>
                            <td class="col-price price">${formatCurrency(item.price)}</td>
                            <td class="col-subtotal line-total">${formatCurrency(item.lineTotal)}</td>
                        `);
                        if (settings.show_cost) itemRow.insertAdjacentHTML('beforeend', `<td class="col-cost-price price">${formatCurrency(item.cost)}</td><td class="col-cost-subtotal cost-line-total">${formatCurrency(item.costLineTotal)}</td>`);

                        if ((index + 1) % settings.group_size === 0 || (index + 1) === items.length) {
                            // [変更] 税表示が「有」の場合、小計・税・合計の3行を表示
                            // [修正] groupTaxの計算を追加し、不具合を修正
                            if (settings.show_tax) {
                                const groupTax = calculateTax(groupSubtotal, settings.tax_method);
                                totalTax += groupTax; // 最終合計のための税額を加算

                                const subtotalRow = summaryTbody.insertRow();
                                subtotalRow.className = 'group-summary-row';
                                subtotalRow.innerHTML = `<td colspan="2"></td><td class="group-summary-label">グループ小計</td><td class="group-summary-value">${formatCurrency(groupSubtotal)}</td>${settings.show_cost ? '<td></td><td></td>' : ''}`;
                                const taxRow = summaryTbody.insertRow();
                                taxRow.className = 'group-summary-row';
                                taxRow.innerHTML = `<td colspan="2"></td><td class="group-summary-label">消費税</td><td class="group-summary-value">${formatCurrency(groupTax)}</td>${settings.show_cost ? '<td></td><td></td>' : ''}`;
                                const totalRow = summaryTbody.insertRow();
                                totalRow.className = 'group-summary-row group-total-row';
                                totalRow.innerHTML = `<td colspan="2"></td><td class="group-summary-label">グループ合計</td><td class="group-summary-value">${formatCurrency(groupSubtotal + groupTax)}</td>${settings.show_cost ? '<td></td><td></td>' : ''}`;
                            } else {
                                // 税表示がない場合は、従来の小計行のみ表示
                                const subtotalRow = summaryTbody.insertRow();
                                subtotalRow.className = 'group-subtotal-row';
                                subtotalRow.innerHTML = `
                                    <td colspan="2"></td>
                                    <td class="group-subtotal-label">グループ小計</td>
                                    <td class="group-subtotal-value">${formatCurrency(groupSubtotal)}</td>
                                    ${settings.show_cost ? `
                                        <td></td>
                                        <td class="group-subtotal-value">${formatCurrency(groupCostSubtotal)}</td>
                                    ` : ''}
                                `;
                            }
                            groupSubtotal = 0;
                            groupCostSubtotal = 0;
                        }
                    });
                } else {
                    summaryCard.style.display = 'none';
                }

                // 最終合計の表示
                subtotalEl.textContent = formatCurrency(subtotal);
                if (settings.show_tax) {
                    taxEl.textContent = formatCurrency(totalTax);
                    grandTotalEl.textContent = formatCurrency(subtotal + totalTax); // [修正] grandTotalElのテキストを先に設定
                    // [修正] 親要素ではなく、要素自体を操作する
                    taxEl.style.display = 'inline';
                    grandTotalEl.style.display = 'inline';
                } else {
                    taxEl.style.display = 'none';
                    grandTotalEl.style.display = 'none';
                }
            };

            const renderSuggestions = (customers) => {
                suggestionsContainer.innerHTML = '';
                customers.forEach(customer => {
                    const div = document.createElement('div');
                    div.textContent = customer;
                    div.addEventListener('click', () => {
                        searchInput.value = customer;
                        suggestionsContainer.style.display = 'none';
                        renderProductList();
                    });
                    suggestionsContainer.appendChild(div);
                });
                suggestionsContainer.style.display = customers.length > 0 ? 'block' : 'none';
            };

            // --- イベントハンドラ ---
            const updateAllCalculations = () => {
                updateRowTotals();
                const { itemsWithQuantity, totalSubtotal } = getCalculationData();
                renderSummary(itemsWithQuantity, totalSubtotal);
            };

            const saveInvoice = () => {
                const customer = searchInput.value;
                if (!customer) {
                    alert('得意先が選択されていません。');
                    return;
                }
                const { itemsWithQuantity, totalSubtotal } = getCalculationData();
                if (itemsWithQuantity.length === 0) {
                    alert('数量が入力されていません。');
                    return;
                }

                const settings = customerSettings[customer] || DEFAULT_SETTINGS;
                let totalTax = 0;

                // [変更] グループごとに税額を計算して保存
                if (settings.show_tax) {
                    let groupSubtotal = 0;
                    itemsWithQuantity.forEach((item, index) => {
                        groupSubtotal += item.lineTotal;
                        if ((index + 1) % settings.group_size === 0 || (index + 1) === itemsWithQuantity.length) { // [修正] 得意先設定に応じた税計算
                            totalTax += calculateTax(groupSubtotal, settings.tax_method);
                            groupSubtotal = 0;
                        }
                    });
                } else {
                    totalTax = 0; // 税表示なしの場合は0
                }

                const newInvoice = {
                    id: Date.now(),
                    date: new Date().toLocaleString('ja-JP'),
                    customer,
                    items: itemsWithQuantity.map(i => ({ name: i.productName, price: i.price, quantity: i.quantity })),
                    subtotal: totalSubtotal,
                    tax: totalTax,
                    total: totalSubtotal + totalTax,
                };

                // [変更] FirebaseではなくLocalStorageに保存
                const savedInvoices = JSON.parse(localStorage.getItem(INVOICE_KEY)) || [];
                savedInvoices.unshift(newInvoice);
                localStorage.setItem(INVOICE_KEY, JSON.stringify(savedInvoices));

                saveStatusEl.textContent = '保存しました！';
                saveStatusEl.style.color = 'green';
                setTimeout(() => { saveStatusEl.textContent = ''; }, 3000);
            };

            // --- 初期化処理 ---
            const init = () => {
                // [変更] 初回起動時に初期データをセットする
                if (localStorage.getItem(PRODUCT_DATA_KEY) === null) {
                    console.log('初回起動のため、初期データをlocalStorageに保存します。');
                    localStorage.setItem(PRODUCT_DATA_KEY, JSON.stringify(INITIAL_PRODUCT_DATA));
                    localStorage.setItem(CUSTOMER_SETTINGS_KEY, JSON.stringify(INITIAL_CUSTOMER_SETTINGS));
                    localStorage.setItem(CUSTOMER_USAGE_KEY, JSON.stringify(INITIAL_CUSTOMER_USAGE || {}));
                }

                masterData = JSON.parse(localStorage.getItem(PRODUCT_DATA_KEY)) || {};
                customerSettings = JSON.parse(localStorage.getItem(CUSTOMER_SETTINGS_KEY)) || {};
                let customers = Object.keys(masterData);

                // イベントリスナー設定
                productTbody.addEventListener('input', (e) => {
                    if (e.target.classList.contains('quantity')) {
                        updateAllCalculations();
                    }
                });

                searchInput.addEventListener('input', () => {
                    const query = searchInput.value.toLowerCase();
                    const usage = JSON.parse(localStorage.getItem(CUSTOMER_USAGE_KEY)) || {};
                    const sortedCustomers = [...customers].sort((a, b) => (usage[b] || 0) - (usage[a] || 0));
                    const filtered = query ? sortedCustomers.filter(c => c.toLowerCase().includes(query)) : sortedCustomers;
                    renderSuggestions(filtered);
                });

                searchInput.addEventListener('focus', () => {
                    const usage = JSON.parse(localStorage.getItem(CUSTOMER_USAGE_KEY)) || {};
                    const sortedCustomers = [...customers].sort((a, b) => (usage[b] || 0) - (usage[a] || 0));
                    renderSuggestions(sortedCustomers);
                });

                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.search-container')) {
                        suggestionsContainer.style.display = 'none';
                    }
                });
                
                saveButton.onclick = null; // HTMLのonclickを無効化
                saveButton.addEventListener('click', saveInvoice);

                // 初期表示
                customers = Object.keys(masterData); // customersを再設定
                updateAllCalculations(); // データを元に画面を更新
            };

            init();
        });
    </script>
</body>
</html>
