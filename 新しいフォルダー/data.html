<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>データ管理</title>
    <link rel="stylesheet" href="style.css">
    <!-- [追加] パスワード認証スクリプト -->
    <script src="auth.js"></script>
    <!-- ライブラリの読み込み -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>データ管理</h1>
            <nav>
                <a href="index.html">計算ページへ</a>
                <a href="list.html">保存済み一覧へ</a>
            </nav>
        </header>
        
        <div class="card">
            <h2>initial-data.js 生成ツール</h2>
            <p>Excelファイルから `initial-data.js` の内容を生成します。生成されたコードをコピーし、`initial-data.js` ファイルに貼り付けてください。</p>
            <p>※Excelのフォーマットは「得意先・商品データインポート」と同じものを使用してください。</p>
            <input type="file" id="initial-data-excel-file" accept=".xlsx, .xls">
            <button onclick="generateInitialData()">コードを生成</button>
            <p id="generate-status" class="status-message"></p>
            <textarea id="generated-code" rows="15" readonly placeholder="ここに生成されたコードが表示されます..."></textarea>
        </div>

        <!-- 「現在登録されているデータ」の表示を非表示にしました -->
    </div>

    <script>
        // [追加] initial-data.js の内容を生成する関数
        function generateInitialData() {
            const fileInput = document.getElementById('initial-data-excel-file');
            const statusEl = document.getElementById('generate-status');
            const outputTextarea = document.getElementById('generated-code');

            if (fileInput.files.length === 0) {
                statusEl.textContent = 'ファイルが選択されていません。';
                statusEl.style.color = 'red';
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(event) {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    const productData = {};
                    const customerSettings = {};

                    jsonData.forEach(row => {
                        const customer = row.得意先名;
                        if (!customer) return;

                        if (!productData[customer]) {
                            productData[customer] = [];
                        }
                        productData[customer].push({
                            name: row.商品名,
                            price: row.単価,
                            cost: row.原価 || 0
                        });

                        if (!customerSettings[customer]) {
                            customerSettings[customer] = {
                                show_tax: row.税表示 === '有',
                                group_size: parseInt(row.伝票行数, 10) || 6,
                                show_cost: row.原価表示 === '有',
                                tax_method: (() => {
                                    if (row.税計算 === '切り捨て') return 'floor';
                                    if (row.税計算 === '切り上げ') return 'ceil';
                                    return 'round';
                                })()
                            };
                        }
                    });

                    const productDataString = `const INITIAL_PRODUCT_DATA = ${JSON.stringify(productData, null, 4)};`;
                    const settingsDataString = `const INITIAL_CUSTOMER_SETTINGS = ${JSON.stringify(customerSettings, null, 4)};`;
                    const usageString = `const INITIAL_CUSTOMER_USAGE = {};`;

                    const finalCode = `// このコードを initial-data.js に貼り付けてください。\n\n${productDataString}\n\n${settingsDataString}\n\n${usageString}`;

                    outputTextarea.value = finalCode;
                    statusEl.textContent = 'コードの生成が完了しました。下のボックスからコピーしてください。';
                    statusEl.style.color = 'green';

                } catch (e) {
                    console.error(e);
                    statusEl.textContent = 'ファイルの読み込みに失敗しました。形式を確認してください。';
                    statusEl.style.color = 'red';
                }
            };
            reader.readAsArrayBuffer(file);
        }
    </script>
</body>
</html>
