<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>保存済み一覧</title>
    <link rel="stylesheet" href="style.css">
    <!-- [追加] パスワード認証スクリプト -->
    <script src="auth.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>保存済み一覧</h1>
            <nav>
                <a href="index.html">計算ページへ</a>
                <a href="data.html">データ管理へ</a>
            </nav>
        </header>

        <div class="list-controls">
            <p>保存されているすべてのデータを削除します。</p>
            <button id="delete-all-btn" class="button-danger">すべて削除</button>
        </div>

        <div id="invoice-list">
            <!-- 保存されたデータがここに表示されます -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const INVOICE_KEY = 'savedInvoices';
            const listContainer = document.getElementById('invoice-list');
            const deleteAllBtn = document.getElementById('delete-all-btn');

            // --- ヘルパー関数 ---
            const formatCurrency = (num) => {
                if (num < 0) return `▲${Math.abs(num).toLocaleString()}円`;
                return `${num.toLocaleString()}円`;
            };

            const getInvoices = () => JSON.parse(localStorage.getItem(INVOICE_KEY)) || [];
            const saveInvoices = (invoices) => localStorage.setItem(INVOICE_KEY, JSON.stringify(invoices));

            // --- 描画関数 ---
            const renderInvoiceList = () => {
                const invoices = getInvoices();
                listContainer.innerHTML = '';

                if (invoices.length === 0) {
                    listContainer.innerHTML = '<p>保存されたデータはありません。</p>';
                    return;
                }

                const fragment = document.createDocumentFragment();
                invoices.forEach(invoice => {
                    const card = document.createElement('div');
                    card.className = 'card invoice-card';

                    const header = document.createElement('h3');
                    header.className = 'invoice-header';
                    header.textContent = invoice.customer; // 安全なtextContentを使用

                    const detailsList = document.createElement('ul');
                    detailsList.className = 'invoice-details';
                    detailsList.style.display = 'none';
                    invoice.items.forEach(item => {
                        const li = document.createElement('li');
                        // [セキュリティ修正] innerHTMLを避け、textContentで安全に設定
                        li.textContent = `${item.name} (${formatCurrency(item.price)} x ${item.quantity > 0 ? item.quantity : '▲' + Math.abs(item.quantity)}) = ${formatCurrency(item.price * item.quantity)}`;
                        detailsList.appendChild(li);
                    });

                    const summaryDiv = document.createElement('div');
                    summaryDiv.className = 'invoice-summary';
                    summaryDiv.innerHTML = `
                        <div class="invoice-summary">
                            <span><strong>保存日時:</strong> ${invoice.date}</span>
                            <span><strong>小計:</strong> ${formatCurrency(invoice.subtotal)}</span>
                            <span><strong>合計:</strong> <span class="grand-total">${formatCurrency(invoice.total)}</span></span>
                        </div>
                    `;

                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'delete-btn';
                    deleteButton.dataset.id = invoice.id;
                    deleteButton.textContent = '削除';

                    card.appendChild(header);
                    card.appendChild(detailsList);
                    card.appendChild(summaryDiv);
                    card.appendChild(deleteButton);
                    fragment.appendChild(card);
                });
                listContainer.appendChild(fragment);
            };

            // --- イベントハンドラ ---
            const handleDeleteInvoice = (id) => {
                if (confirm('このデータを本当に削除しますか？')) {
                    let invoices = getInvoices();
                    invoices = invoices.filter(invoice => invoice.id !== id);
                    saveInvoices(invoices);
                    renderInvoiceList();
                }
            };

            const handleDeleteAllInvoices = () => {
                const invoices = getInvoices();
                if (invoices.length === 0) {
                    alert('削除するデータがありません。');
                    return;
                }
                if (confirm('本当にすべてのデータを削除しますか？この操作は元に戻せません。')) {
                    localStorage.removeItem(INVOICE_KEY);
                    renderInvoiceList();
                }
            };

            // --- イベントリスナー設定 ---
            listContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('invoice-header')) {
                    const details = e.target.closest('.invoice-card').querySelector('.invoice-details');
                    details.style.display = details.style.display === 'none' ? 'block' : 'none';
                }
                if (e.target.classList.contains('delete-btn')) {
                    const invoiceId = parseInt(e.target.dataset.id, 10);
                    handleDeleteInvoice(invoiceId);
                }
            });

            deleteAllBtn.addEventListener('click', handleDeleteAllInvoices);

            // --- 初期化 ---
            renderInvoiceList();
        });
    </script>
</body>
</html>
