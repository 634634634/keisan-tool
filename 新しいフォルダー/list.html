<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>保存済み一覧</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>保存済み一覧</h1>
            <nav>
                <a href="index.html">計算ページへ</a>
                <a href="data.html">データ管理へ</a>
            </nav>
        </header>

        <div class="list-controls">
            <p>保存されているすべてのデータを削除します。</p>
            <button onclick="deleteAllInvoices()" class="button-danger">すべて削除</button>
        </div>

        <div id="invoice-list">
            <!-- 保存されたデータがここに表示されます -->
        </div>
    </div>

    <script>
        const INVOICE_KEY = 'savedInvoices';
        // [修正] マイナス表示に対応
        const formatCurrency = (num) => {
            if (num < 0) return `▲${Math.abs(num).toLocaleString()}円`;
            return `${num.toLocaleString()}円`;
        };

        function renderInvoiceList() {
            const invoices = JSON.parse(localStorage.getItem(INVOICE_KEY)) || [];
            const listContainer = document.getElementById('invoice-list');
            listContainer.innerHTML = '';

            if (invoices.length === 0) {
                listContainer.innerHTML = '<p>保存されたデータはありません。</p>';
                return;
            }

            invoices.forEach(invoice => {
                const card = document.createElement('div');
                card.className = 'card invoice-card';

                let itemsHtml = invoice.items.map(item => `
                    <li>${item.name} (${formatCurrency(item.price)} x ${item.quantity > 0 ? item.quantity : '▲' + Math.abs(item.quantity)}) = ${formatCurrency(item.price * item.quantity)}</li>
                `).join('');

                card.innerHTML = `
                    <h3 class="invoice-header">${invoice.customer}</h3>
                    <div class="invoice-summary">
                        <span><strong>保存日時:</strong> ${invoice.date}</span>
                        <span><strong>小計:</strong> ${formatCurrency(invoice.subtotal)}</span>
                        <span><strong>合計:</strong> <span class="grand-total">${formatCurrency(invoice.total)}</span></span>
                    </div>
                    <button onclick="deleteInvoice(${invoice.id})">削除</button>
                `;

                const details = document.createElement('ul');
                details.className = 'invoice-details';
                details.style.display = 'none'; // 初期状態は非表示
                details.innerHTML = itemsHtml;
                card.insertBefore(details, card.querySelector('.invoice-summary'));

                listContainer.appendChild(card);
            });
        }

        function deleteInvoice(id) {
            if (confirm('このデータを本当に削除しますか？')) {
                let invoices = JSON.parse(localStorage.getItem(INVOICE_KEY)) || [];
                invoices = invoices.filter(invoice => invoice.id !== id);
                localStorage.setItem(INVOICE_KEY, JSON.stringify(invoices));
                renderInvoiceList(); // リストを再描画
            }
        }

        // [追加] すべての請求データを削除する関数
        function deleteAllInvoices() {
            const invoices = JSON.parse(localStorage.getItem(INVOICE_KEY)) || [];
            if (invoices.length === 0) {
                alert('削除するデータがありません。');
                return;
            }
            if (confirm('本当にすべてのデータを削除しますか？この操作は元に戻せません。')) {
                localStorage.removeItem(INVOICE_KEY);
                renderInvoiceList(); // リストを再描画
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderInvoiceList();
            document.getElementById('invoice-list').addEventListener('click', (e) => {
                if (e.target.classList.contains('invoice-header')) {
                    const details = e.target.closest('.invoice-card').querySelector('.invoice-details');
                    details.style.display = details.style.display === 'none' ? 'block' : 'none';
                }
            });
        });
    </script>
</body>
</html>
