<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>納品金額計算</title>
    <style>
        /* スタイルは変更なし */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; color: #333; width: 500px; margin: 20px auto; padding: 0 5px; background-color: #f9f9f9; font-size: 17px; }
        h1, h2, h3 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 8px; }
        /* ★★★ メインタイトルの調整 ★★★ */
        h1 { font-size: 1.4em; margin-top: 0; margin-bottom: 15px; }
        /* ★★★ 伝票内容見出しの調整 ★★★ */
        h2 { font-size: 1.1em; margin-top: 20px; border-bottom-style: dashed; }
        h3 { font-size: 1.2em; margin-top: 20px; border-bottom: 1px solid #ccc; color: #34495e; }
        .container { background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; table-layout: fixed; }
        /* ★★★ 得意先名（サブタイトル）のスタイル ★★★ */
        .customer-name-subtitle {
            font-size: 1.2em;
            font-weight: bold;
            margin: -10px 0 20px 0;
        }
        th, td { border: 1px solid #ddd; padding: 3px 4px; text-align: left; vertical-align: middle; word-wrap: break-word; } /* ★★★ 左右の余白を調整 ★★★ */
        th { background-color: #f2f2f2; }
        input { box-sizing: border-box; width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; text-align: right; }
        .subtotal, .total-value, .price-cell, .cost-subtotal {
            text-align: right;
            font-size: 0.9em; /* ★★★ 数字のフォントを少し小さく ★★★ */
        }
        .product-name-cell {
            text-align: right;
            font-size: 0.85em; /* ★★★ 商品名のフォントをさらに小さく ★★★ */
        }
        #customerProductsTable .quantity-input { width: 100%; text-align: right; }
        .subtotal-row td { background-color: #f0f8ff; font-weight: bold; }
        .total-label { text-align: right; }
        .total-value { color: #333; }
        .back-link { display: inline-block; margin-bottom: 20px; color: #3498db; text-decoration: none; }
        .back-link:hover { text-decoration: underline; }
        /* ★★★ ヘッダーのスタイル調整 ★★★ */
        th {
            background-color: #f2f2f2;
            text-align: center;
            font-weight: normal; /* ★★★ ヘッダーの太字を解除 ★★★ */
        }
        /* 上段の商品リストの列幅 */
        .col-product-name { width: 45%; } .col-quantity { width: 15%; } .col-price { width: 14%; } .col-sell-price { width: 14%; } .col-department { width: 12%; text-align: center; }
        /* 下段の伝票の列幅 */
        .invoice-col-name { width: 43%; } .invoice-col-qty { width: 7%; } .invoice-col-cost-price { width: 10%; } .invoice-col-cost-sub { width: 15%; } .invoice-col-price { width: 10%; } .invoice-col-sub { width: 15%; }


        /* ★★★ 商品名と数字以外の文字を小さくする ★★★ */
        th, .col-department, .total-label {
            font-size: 0.8em; /* ★★★ フォントサイズをさらに小さく ★★★ */
        }

        /* ★★★ 売価の表示・非表示切り替えスタイル ★★★ */
        .sell-price-input {
            display: none;
            -moz-appearance: textfield; /* Firefoxで矢印を非表示 */
        }
        /* ★★★ 売価入力欄の矢印を非表示にする (Chrome, Safari, Edge) ★★★ */
        .sell-price-input::-webkit-outer-spin-button,
        .sell-price-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .is-editing-prices .sell-price-input { display: block; }
        .is-editing-prices .sell-price-display { display: none; }
        .sell-price-display {
            display: block;
            text-align: right;
        }

        /* ★★★ スマホ表示用の調整 ★★★ */
        @media (max-width: 768px) {
            body {
                font-size: 16px; /* スマホでは少し文字を小さく */
                margin-top: 10px;
                margin-bottom: 10px;
            }
            .container {
                padding: 10px; /* スマホではコンテナの余白をさらに詰める */
            }
            h2 {
                margin-top: 25px; /* スマホでは見出しの上の余白を詰める */
            }
        }

        /* ★★★ トースト通知のスタイル ★★★ */
        .toast-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(44, 62, 80, 0.85);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s, top 0.5s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .toast-notification.show { opacity: 1; top: 30px; }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">&laquo; 得意先一覧に戻る</a>
        <h1>納品金額計算</h1>
        <p id="customerNameHeader" class="customer-name-subtitle"></p>
        <div id="customerProductsContainer">
            <p>数量を入力すると、下の伝票に自動で反映されます。</p>
            <!-- ★★★ 一時保存ボタンを追加 ★★★ -->
            <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button id="saveButton" class="action-button" style="background-color: #3498db;">入力内容を一時保存</button>
                <button id="clearButton" class="action-button" style="background-color: #e74c3c;">入力内容をクリア</button>
                <button id="editPricesButton" class="action-button" style="background-color: #2ecc71;">売価を編集</button>
            </div>
            <table id="customerProductsTable">
                <thead>
                    <tr>
                        <th class="col-product-name">商品名</th><th class="col-quantity">数量</th><th class="col-price">単価</th><th class="col-sell-price">売価</th><th class="col-department">部門</th>
                    </tr>
                </thead>
                <tbody><tr><td colspan="4">データを読み込んでいます...</td></tr></tbody>
            </table>
        </div>
    </div>
    <div class="container">
        <h2><strong>伝票内容</strong></h2>
        <div id="invoiceContainer"></div>
    </div>

    <script>
        // ★★★ ここから修正 ★★★
        const MASTER_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRpGhiBjllLFan-dzUY5k9Bog2RKMGdcEph5E4itfZaOVQ1dEZQIqNM6_vGG5OsUyvwfeC4nDG-64aa/pub?gid=0&single=true&output=csv';
        // ★★★ ここに、先ほどコピーしたGASのウェブアプリURLを貼り付けます ★★★
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbykg6NpdFiQi9By9wNCOP6StfQ3GZGf0hpDrjs3UTnhQ33D8RLZkZUWTWGTMpVdQmqOtw/exec';

        // ★★★ ボタンの共通スタイルを追加 ★★★
        const style = document.createElement('style');
        style.textContent = `
            .action-button { padding: 8px 12px; border: none; color: white; border-radius: 4px; cursor: pointer; }
        `;
        document.head.appendChild(style);

        async function fetchCsvAsJson(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok.');
                const csvText = await response.text();
                const lines = csvText.trim().split(/\r\n|\n/);

                // CSVの1行をパースする関数（引用符対応）
                const parseCsvRow = (row) => {
                    const result = [];
                    let current = '';
                    let inQuotes = false;
                    for (let i = 0; i < row.length; i++) {
                        const char = row[i];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            result.push(current);
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    result.push(current);
                    return result.map(val => val.replace(/^"|"$/g, '').trim());
                };

                const headers = parseCsvRow(lines[0]);
                return lines.slice(1).map(line => {
                    const values = parseCsvRow(line);
                    return headers.reduce((obj, header, index) => {
                        const rawValue = values[index];
                        // 値からカンマを削除してから数値に変換
                        const cleanValue = typeof rawValue === 'string' ? rawValue.replace(/,/g, '') : rawValue;
                        obj[header] = isNaN(cleanValue) || cleanValue === '' ? rawValue : parseFloat(cleanValue);
                        return obj;
                    }, {});
                });
            } catch (error) {
                console.error('Error fetching or parsing CSV:', error);
                return [];
            }
        }

        // 安全にテキストをセルに設定するヘルパー関数
        function createCell(text, className) {
            const cell = document.createElement('td');
            cell.textContent = text;
            if (className) {
                cell.className = className;
            }
            return cell;
        }

        // ★★★ トースト通知を表示する関数 ★★★
        function showToast(message, duration = 2000) {
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.textContent = message;
            document.body.appendChild(toast);

            // 少し遅れて表示クラスを追加し、フェードインアニメーションを開始
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            // 指定時間後に非表示クラスに戻し、フェードアウトさせる
            setTimeout(() => {
                toast.classList.remove('show');
                // アニメーション完了後に要素を削除
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        }


        // ★★★ キャッシュ対策：戻るリンクにタイムスタンプを付与 ★★★
        const backLink = document.querySelector('.back-link');
        if (backLink) backLink.href = `index.html?_=${new Date().getTime()}`;

        document.addEventListener('DOMContentLoaded', async () => {
            const customerProductsTableBody = document.querySelector('#customerProductsTable tbody');
            const invoiceContainer = document.getElementById('invoiceContainer');

            const params = new URLSearchParams(window.location.search);
            const customerId = parseInt(params.get('customerId'), 10);

            const saveButton = document.getElementById('saveButton');
            const clearButton = document.getElementById('clearButton');
            const editPricesButton = document.getElementById('editPricesButton');

            if (!customerId) {
                document.querySelector('body').innerHTML = `<div class="container"><h1>エラー</h1><p>有効な得意先が選択されていません。</p><a href="customers.html">得意先一覧に戻ってください。</a></div>`;
                return;
            }

            const masterData = await fetchCsvAsJson(MASTER_DATA_URL);
            
            // この得意先に関連するデータだけをフィルタリング
            const customerSpecificData = masterData.filter(row => row['得意先コード'] === customerId);

            if (customerSpecificData.length === 0) {
                 document.querySelector('body').innerHTML = `<div class="container"><h1>エラー</h1><p>指定された得意先のデータが見つかりません。</p><a href="customers.html">得意先一覧に戻ってください。</a></div>`;
                return;
            }

            const customerName = customerSpecificData[0]['得意先名'];
            document.getElementById('customerNameHeader').textContent = customerName;

            displayCustomerProducts(customerName, customerSpecificData);
            loadQuantitiesAndGenerateInvoices(customerSpecificData);

            saveButton.addEventListener('click', () => saveQuantities(customerId));
            clearButton.addEventListener('click', () => clearQuantities(customerId, customerSpecificData));
            
            // ★★★ 編集と保存を統合したボタンのイベントリスナー ★★★
            editPricesButton.addEventListener('click', async () => {
                const isEditing = customerProductsTableBody.classList.contains('is-editing-prices');

                if (isEditing) {
                    // 保存モードの場合：保存処理を実行
                    await savePricesToSheet(customerSpecificData);

                    // 編集モードを終了
                    customerProductsTableBody.classList.remove('is-editing-prices');
                    editPricesButton.textContent = '売価を編集';
                    editPricesButton.style.backgroundColor = '#2ecc71';

                    // 表示を更新
                    customerProductsTableBody.querySelectorAll('tr[data-product-id]').forEach(row => {
                        const sellPrice = parseFloat(row.querySelector('.sell-price-input').value);
                        const displaySpan = row.querySelector('.sell-price-display');
                        displaySpan.textContent = (sellPrice && sellPrice > 0) ? sellPrice.toLocaleString() : '';
                    });
                } else {
                    // 編集モードの場合：編集モードを開始
                    customerProductsTableBody.classList.add('is-editing-prices');
                    editPricesButton.textContent = '売価を保存';
                    editPricesButton.style.backgroundColor = '#16a085'; // 保存ボタンの色
                }
            });

            customerProductsTableBody.addEventListener('input', () => generateInvoices(customerSpecificData));
            
            // ★★★ Enterキーで次の数量入力欄に移動する機能 ★★★
            customerProductsTableBody.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.target.classList.contains('quantity-input')) {
                    e.preventDefault(); // フォームの送信を防ぐ
                    const allInputs = Array.from(customerProductsTableBody.querySelectorAll('.quantity-input'));
                    const currentIndex = allInputs.indexOf(e.target);
                    const nextIndex = currentIndex + 1;
                    if (nextIndex < allInputs.length) {
                        allInputs[nextIndex].focus();
                        allInputs[nextIndex].select(); // 次の入力欄のテキストを選択状態にする
                    } else {
                        // 最後の入力欄ならフォーカスを外す
                        e.target.blur();
                    }
                }
            });


            function displayCustomerProducts(customerName, products) {
                customerProductsTableBody.innerHTML = '';

                if (products.length > 0) {
                    products.forEach(product => {
                        const row = document.createElement('tr');
                        // データ属性としてproductIdだけでなく、行全体の情報を保持すると後で楽
                        row.dataset.productId = product['商品コード'];
                        
                        const sellPrice = product['売価'];
                        const sellPriceText = (sellPrice && sellPrice > 0) ? sellPrice.toLocaleString() : '';
                        const sellPriceValue = (sellPrice && sellPrice > 0) ? sellPrice : '';

                        const sellPriceDisplay = `<span class="sell-price-display">${sellPriceText}</span>`;
                        const sellPriceInput = `<input type="number" class="sell-price-input" min="0" value="${sellPriceValue}">`;

                        row.innerHTML = `<td class="product-name-cell">${product['商品名']}</td>
                                         <td><input type="number" class="quantity-input" min="0" placeholder="0"></td>
                                         <td class="price-cell">${(product['単価'] || 0).toLocaleString()}</td>
                                         <td class="price-cell">${sellPriceDisplay}${sellPriceInput}</td>
                                         <td class="col-department">${product['部門']}</td>`;
                        customerProductsTableBody.appendChild(row);
                    });
                } else {
                    customerProductsTableBody.innerHTML = '<tr><td colspan="5">この得意先に登録されている商品はありません。</td></tr>';
                }
            }

            // ★★★ ここから一時保存関連の関数 ★★★

            function saveQuantities(customerId) {
                const quantities = {};
                customerProductsTableBody.querySelectorAll('tr[data-product-id]').forEach(row => {
                    const productId = row.dataset.productId;
                    const quantity = row.querySelector('.quantity-input').value;
                    const sellPrice = row.querySelector('.sell-price-input').value;

                    if ((quantity && parseFloat(quantity) > 0) || (sellPrice && parseFloat(sellPrice) > 0)) {
                        quantities[productId] = {
                            quantity: quantity || '0',
                            sellPrice: sellPrice || ''
                        };
                    }
                });
                localStorage.setItem(`savedQuantities_${customerId}`, JSON.stringify(quantities));
                showToast('入力内容を保存しました。');
            }

            function loadQuantitiesAndGenerateInvoices(products) {
                const savedData = JSON.parse(localStorage.getItem(`savedQuantities_${customerId}`) || '{}');
                customerProductsTableBody.querySelectorAll('tr[data-product-id]').forEach(row => {
                    const productId = row.dataset.productId;
                    if (savedData[productId]) {
                        // 数量が'0'の場合は、入力ボックスを空にする
                        row.querySelector('.quantity-input').value = savedData[productId].quantity === '0' ? '' : savedData[productId].quantity;
                        // 売価も復元
                        if (savedData[productId].sellPrice) {
                            row.querySelector('.sell-price-input').value = savedData[productId].sellPrice;
                        }
                    }
                });
                generateInvoices(products); // 数量を復元した後に伝票を生成
            }

            function clearQuantities(customerId, products) {
                if (confirm('入力中の内容と一時保存したデータをすべてクリアします。よろしいですか？')) {
                    localStorage.removeItem(`savedQuantities_${customerId}`);
                    customerProductsTableBody.querySelectorAll('.quantity-input, .sell-price-input').forEach(input => {
                        input.value = '';
                    });
                    displayCustomerProducts(customerName, products); // 売価を元の値に戻すため再描画
                    generateInvoices(products); // 伝票をクリア
                }
            }

            // ★★★ スプレッドシートに保存する関数 ★★★
            async function savePricesToSheet(products) {
                if (GAS_WEB_APP_URL === 'ここにGASのウェブアプリURLを貼り付け') {
                    alert('エラー: Google Apps ScriptのウェブアプリURLが設定されていません。');
                    return;
                }

                const updates = [];
                customerProductsTableBody.querySelectorAll('tr[data-product-id]').forEach(row => {
                    const productId = parseInt(row.dataset.productId, 10);
                    const originalProduct = products.find(p => p['商品コード'] === productId);
                    const newSellPriceInput = row.querySelector('.sell-price-input').value;
                    
                    // 元の売価（未設定ならnull）と新しい売価（空ならnull）を準備
                    const originalSellPrice = originalProduct ? (originalProduct['売価'] || null) : null;
                    const newSellPrice = newSellPriceInput !== '' ? parseFloat(newSellPriceInput) : null;

                    // 2つの値を比較して、変更があった場合のみ更新対象とする
                    if (originalSellPrice !== newSellPrice) {
                        updates.push({
                            '商品コード': productId,
                            '売価': newSellPrice
                        });
                    }
                });

                if (updates.length === 0) {
                    alert('スプレッドシートの元の値から変更された売価はありません。');
                    return;
                }

                if (!confirm(`${updates.length}件の売価を保存します。よろしいですか？`)) {
                    return;
                }

                editPricesButton.disabled = true;
                editPricesButton.textContent = '保存中...';

                try {
                    const response = await fetch(GAS_WEB_APP_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // GASの仕様上、text/plainで送る
                        body: JSON.stringify({ updates: updates })
                    });
                    const result = await response.json();
                    showToast(result.message || '処理が完了しました。');
                } catch (error) {
                    alert('保存中にエラーが発生しました。\n' + error.message);
                } finally {
                    editPricesButton.disabled = false;
                    // ボタンのテキストは、この関数の呼び出し元で「売価を編集」に戻される
                }
            }

            // ★★★ ここまで一時保存関連の関数 ★★★


            function generateInvoices(products) {
                const allItems = collectAllItems(products);
                const groupedByDept = groupItemsByDepartment(allItems);
                renderInvoices(groupedByDept);
            }

            function collectAllItems(products) {
                const items = [];
                customerProductsTableBody.querySelectorAll('tr[data-product-id]').forEach(row => {
                    const quantity = parseFloat(row.querySelector('.quantity-input').value);
                    if (quantity > 0) {
                        const productId = parseInt(row.dataset.productId, 10);
                        const productData = products.find(p => p['商品コード'] === productId);
                        const sellPriceInput = row.querySelector('.sell-price-input');
                        const currentSellPrice = parseFloat(sellPriceInput.value);

                        if (productData) {
                            // 編集された売価を反映させる
                            const itemData = { ...productData, quantity };
                            if (!isNaN(currentSellPrice)) itemData['売価'] = currentSellPrice;
                            items.push(itemData);
                        }
                    }
                });
                return items;
            }

            function groupItemsByDepartment(items) {
                const grouped = {};
                items.forEach(item => {
                    const deptId = item['部門コード'];
                    if (!grouped[deptId]) {
                        grouped[deptId] = { name: item['部門'], items: [] };
                    }
                    grouped[deptId].items.push(item);
                });
                return grouped;
            }

            function renderInvoices(groupedData) {
                invoiceContainer.innerHTML = '';
                for (const deptId in groupedData) {
                    const dept = groupedData[deptId];
                    const departmentHeader = document.createElement('h3');
                    departmentHeader.textContent = dept.name;
                    invoiceContainer.appendChild(departmentHeader);
                    const table = document.createElement('table');
                    table.innerHTML = `<thead><tr><th class="invoice-col-name">品名</th><th class="invoice-col-qty">数量</th><th class="invoice-col-cost-price">原単価</th><th class="invoice-col-cost-sub">原価金額</th><th class="invoice-col-price">売単価</th><th class="invoice-col-sub">売価金額</th></tr></thead>`;
                    const tbody = document.createElement('tbody');
                    let itemCounter = 0;
                    let runningSubtotal = 0;
                    let runningCostSubtotal = 0;

                    dept.items.forEach((item, index) => {
                        itemCounter++;
                        const itemSubtotal = item.quantity * item['売価']; // 売価金額 = 数量 * 売価
                        const costSubtotal = item.quantity * (item['単価'] || 0); // 原価金額 = 数量 * 単価(原価)
                        runningSubtotal += itemSubtotal;
                        runningCostSubtotal += costSubtotal;

                        const row = document.createElement('tr');
                        const displayCost = item['単価'] ? item['単価'].toLocaleString() : ''; // 原単価は '単価'
                        const displayCostSubtotal = (item['単価'] && item['単価'] > 0) ? costSubtotal.toLocaleString() : ''; // 原価金額
                        const displaySellPrice = (item['売価'] && item['売価'] > 0) ? item['売価'].toLocaleString() : ''; // 売単価

                        row.appendChild(createCell(item['商品名'], 'product-name-cell'));
                        row.appendChild(createCell(item.quantity, 'price-cell'));
                        row.appendChild(createCell(displayCost, 'price-cell')); // 原単価
                        row.appendChild(createCell(displayCostSubtotal, 'cost-subtotal')); // 原価金額
                        row.appendChild(createCell(displaySellPrice, 'price-cell')); // 売単価
                        row.appendChild(createCell(itemSubtotal.toLocaleString(), 'subtotal'));
                        tbody.appendChild(row);

                        const isLastItem = index === dept.items.length - 1;
                        if (itemCounter % 6 === 0 || isLastItem) {
                            const label = '合計';
                            const subtotalRow = document.createElement('tr');
                            subtotalRow.className = 'subtotal-row';

                            const labelCell1 = createCell(label, 'total-label');
                            labelCell1.colSpan = 3;
                            subtotalRow.appendChild(labelCell1);
                            subtotalRow.appendChild(createCell(runningCostSubtotal.toLocaleString(), 'total-value'));
                            const labelCell2 = createCell(label, 'total-label');
                            subtotalRow.appendChild(labelCell2);
                            subtotalRow.appendChild(createCell(runningSubtotal.toLocaleString(), 'total-value'));

                            tbody.appendChild(subtotalRow);
                            runningSubtotal = 0;
                            runningCostSubtotal = 0;
                        }
                    });
                    table.appendChild(tbody);
                    invoiceContainer.appendChild(table);
                }
            }
        });
        // ★★★ ここまで修正 ★★★
    </script>
</body>
</html>
