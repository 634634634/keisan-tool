<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>納品金額計算</title>
    <style>
        /* スタイルは変更なし */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; color: #333; max-width: 1100px; margin: 20px auto; padding: 0 5px; background-color: #f9f9f9; font-size: 17px; }
        h1, h2, h3 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        h2 { font-size: 1.4em; margin-top: 40px; border-bottom-style: dashed; }
        h3 { font-size: 1.2em; margin-top: 20px; border-bottom: 1px solid #ccc; color: #34495e; }
        .container { background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; table-layout: fixed; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: middle; word-wrap: break-word; }
        th { background-color: #f2f2f2; }
        input { box-sizing: border-box; width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; text-align: right; }
        .subtotal, .total-value, .price-cell, .cost-subtotal {
            text-align: right;
            font-size: 0.9em; /* ★★★ 数字のフォントを少し小さく ★★★ */
        }
        .product-name-cell {
            text-align: right;
            font-size: 0.9em; /* ★★★ 品名のフォントを少し小さく ★★★ */
        }
        #customerProductsTable .quantity-input { width: 100%; text-align: right; }
        .subtotal-row td { background-color: #f0f8ff; font-weight: bold; }
        .total-label { text-align: right; }
        .total-value { color: #333; }
        .back-link { display: inline-block; margin-bottom: 20px; color: #3498db; text-decoration: none; }
        .back-link:hover { text-decoration: underline; }
        /* ★★★ ヘッダーのスタイル調整 ★★★ */
        th {
            background-color: #f2f2f2;
            text-align: center;
            font-weight: normal; /* ★★★ ヘッダーの太字を解除 ★★★ */
        }
        /* 上段の商品リストの列幅 */
        .col-product-name { width: 62%; } .col-quantity { width: 15%; } .col-price { width: 13%; } .col-department { width: 10%; text-align: center; }
        /* 下段の伝票の列幅 */
        .invoice-col-name { width: 30%; } .invoice-col-qty { width: 10%; } .invoice-col-cost-price { width: 13%; } .invoice-col-cost-sub { width: 17%; } .invoice-col-price { width: 13%; } .invoice-col-sub { width: 17%; }


        /* ★★★ 商品名と数字以外の文字を小さくする ★★★ */
        th, .col-department, .total-label {
            font-size: 0.8em; /* ★★★ フォントサイズをさらに小さく ★★★ */
        }

        /* ★★★ スマホ表示用の調整 ★★★ */
        @media (max-width: 768px) {
            body {
                font-size: 16px; /* スマホでは少し文字を小さく */
                margin-top: 10px;
                margin-bottom: 10px;
            }
            .container {
                padding: 10px; /* スマホではコンテナの余白をさらに詰める */
            }
            h2 {
                margin-top: 25px; /* スマホでは見出しの上の余白を詰める */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">&laquo; 得意先一覧に戻る</a>
        <h1>納品金額計算</h1>
        <div id="customerProductsContainer">
            <p>数量を入力すると、下の伝票に自動で反映されます。</p>
            <table id="customerProductsTable">
                <thead>
                    <tr>
                        <th class="col-product-name">商品名</th><th class="col-quantity">数量</th><th class="col-price">単価</th><th class="col-department">部門</th>
                    </tr>
                </thead>
                <tbody><tr><td colspan="4">データを読み込んでいます...</td></tr></tbody>
            </table>
        </div>
    </div>
    <div class="container">
        <h2><strong>伝票内容</strong></h2>
        <div id="invoiceContainer"></div>
    </div>

    <script>
        // ★★★ ここから修正 ★★★
        const MASTER_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRpGhiBjllLFan-dzUY5k9Bog2RKMGdcEph5E4itfZaOVQ1dEZQIqNM6_vGG5OsUyvwfeC4nDG-64aa/pub?gid=0&single=true&output=csv';

        async function fetchCsvAsJson(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok.');
                const csvText = await response.text();
                const lines = csvText.trim().split(/\r\n|\n/);
                const headers = lines[0].split(',');
                return lines.slice(1).map(line => {
                    const values = line.split(',');
                    return headers.reduce((obj, header, index) => {
                        const value = values[index];
                        obj[header] = isNaN(value) || value === '' ? value : parseFloat(value);
                        return obj;
                    }, {});
                });
            } catch (error) {
                console.error('Error fetching or parsing CSV:', error);
                return [];
            }
        }

        // 安全にテキストをセルに設定するヘルパー関数
        function createCell(text, className) {
            const cell = document.createElement('td');
            cell.textContent = text;
            if (className) {
                cell.className = className;
            }
            return cell;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const customerProductsTableBody = document.querySelector('#customerProductsTable tbody');
            const invoiceContainer = document.getElementById('invoiceContainer');

            const params = new URLSearchParams(window.location.search);
            const customerId = parseInt(params.get('customerId'), 10);
            const customerNameEl = document.querySelector('h2 > strong');

            if (!customerId) {
                document.querySelector('body').innerHTML = `<div class="container"><h1>エラー</h1><p>有効な得意先が選択されていません。</p><a href="customers.html">得意先一覧に戻ってください。</a></div>`;
                return;
            }

            const masterData = await fetchCsvAsJson(MASTER_DATA_URL);
            
            // この得意先に関連するデータだけをフィルタリング
            const customerSpecificData = masterData.filter(row => row.customerId === customerId);

            if (customerSpecificData.length === 0) {
                 document.querySelector('body').innerHTML = `<div class="container"><h1>エラー</h1><p>指定された得意先のデータが見つかりません。</p><a href="customers.html">得意先一覧に戻ってください。</a></div>`;
                return;
            }

            const customerName = customerSpecificData[0].customerName;
            displayCustomerProducts(customerName, customerSpecificData);
            generateInvoices(customerSpecificData); // ★★★ 呼び出しをここへ移動 ★★★
            customerProductsTableBody.addEventListener('input', () => generateInvoices(customerSpecificData));

            function displayCustomerProducts(customerName, products) {
                customerProductsTableBody.innerHTML = '';

                if (products.length > 0) {
                    products.forEach(product => {
                        const row = document.createElement('tr');
                        // データ属性としてproductIdだけでなく、行全体の情報を保持すると後で楽
                        row.dataset.productId = product.productId;
                        row.innerHTML = `<td class="product-name-cell">${product.productName}</td><td><input type="number" class="quantity-input" min="0" placeholder="0"></td><td class="price-cell">${product.price.toLocaleString()}</td><td class="col-department">${product.departmentName}</td>`;
                        customerProductsTableBody.appendChild(row);
                    });
                } else {
                    customerProductsTableBody.innerHTML = '<tr><td colspan="4">この得意先に登録されている商品はありません。</td></tr>';
                }
            }

            function generateInvoices(products) {
                const allItems = collectAllItems(products);
                const groupedByDept = groupItemsByDepartment(allItems);
                renderInvoices(groupedByDept);
            }

            function collectAllItems(products) {
                const items = [];
                customerProductsTableBody.querySelectorAll('tr[data-product-id]').forEach(row => {
                    const quantity = parseFloat(row.querySelector('.quantity-input').value);
                    if (quantity > 0) {
                        const productId = parseInt(row.dataset.productId, 10);
                        const productData = products.find(p => p.productId === productId);
                        if (productData) {
                            items.push({ ...productData, quantity });
                        }
                    }
                });
                return items;
            }

            function groupItemsByDepartment(items) {
                const grouped = {};
                items.forEach(item => {
                    const deptId = item.departmentId;
                    if (!grouped[deptId]) {
                        grouped[deptId] = { name: item.departmentName, items: [] };
                    }
                    grouped[deptId].items.push(item);
                });
                return grouped;
            }

            function renderInvoices(groupedData) {
                invoiceContainer.innerHTML = '';
                for (const deptId in groupedData) {
                    const dept = groupedData[deptId];
                    const departmentHeader = document.createElement('h3');
                    departmentHeader.textContent = dept.name;
                    invoiceContainer.appendChild(departmentHeader);
                    const table = document.createElement('table');
                    table.innerHTML = `<thead><tr><th class="invoice-col-name">品名</th><th class="invoice-col-qty">数量</th><th class="invoice-col-cost-price">原単価</th><th class="invoice-col-cost-sub">原価金額</th><th class="invoice-col-price">売単価</th><th class="invoice-col-sub">売価金額</th></tr></thead>`;
                    const tbody = document.createElement('tbody');
                    let itemCounter = 0;
                    let runningSubtotal = 0;
                    let runningCostSubtotal = 0;

                    dept.items.forEach((item, index) => {
                        itemCounter++;
                        const itemSubtotal = item.quantity * item.price;
                        const costSubtotal = item.quantity * (item.cost || 0);
                        runningSubtotal += itemSubtotal;
                        runningCostSubtotal += costSubtotal;

                        const row = document.createElement('tr');
                        const displayCost = item.cost ? item.cost.toLocaleString() : '';
                        const displayCostSubtotal = item.cost ? costSubtotal.toLocaleString() : '';

                        row.appendChild(createCell(item.productName, 'product-name-cell'));
                        row.appendChild(createCell(item.quantity, 'price-cell'));
                        row.appendChild(createCell(item.price.toLocaleString(), 'price-cell'));
                        row.appendChild(createCell(itemSubtotal.toLocaleString(), 'subtotal'));
                        row.appendChild(createCell(displayCost, 'price-cell'));
                        row.appendChild(createCell(displayCostSubtotal, 'cost-subtotal'));
                        tbody.appendChild(row);

                        const isLastItem = index === dept.items.length - 1;
                        if (itemCounter % 6 === 0 || isLastItem) {
                            const label = '合計';
                            const subtotalRow = document.createElement('tr');
                            subtotalRow.className = 'subtotal-row';

                            const labelCell1 = createCell(label, 'total-label');
                            labelCell1.colSpan = 3;
                            subtotalRow.appendChild(labelCell1);
                            subtotalRow.appendChild(createCell(runningSubtotal.toLocaleString(), 'total-value'));
                            subtotalRow.appendChild(createCell(label, 'total-label'));
                            subtotalRow.appendChild(createCell(runningCostSubtotal.toLocaleString(), 'total-value'));

                            tbody.appendChild(subtotalRow);
                            runningSubtotal = 0;
                            runningCostSubtotal = 0;
                        }
                    });
                    table.appendChild(tbody);
                    invoiceContainer.appendChild(table);
                }
            }
        });
        // ★★★ ここまで修正 ★★★
    </script>
</body>
</html>
