<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>納品金額計算</title>
    <style>
        /* スタイルは変更なし */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; color: #333; max-width: 1100px; margin: 20px auto; padding: 0 15px; background-color: #f9f9f9; font-size: 17px; }
        h1, h2, h3 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        h2 { font-size: 1.4em; margin-top: 40px; border-bottom-style: dashed; }
        h3 { font-size: 1.2em; margin-top: 25px; border-bottom: 1px solid #ccc; color: #34495e; }
        .container { background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; table-layout: fixed; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: middle; word-wrap: break-word; }
        th { background-color: #f2f2f2; }
        input { width: 95%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; text-align: right; }
        .subtotal, .total-value, .price-cell, .cost-subtotal { text-align: right; }
        #customerProductsTable .quantity-input { width: 80px; text-align: right; }
        .subtotal-row td { background-color: #f0f8ff; font-weight: bold; }
        .total-label { text-align: right; }
        .total-value { color: #333; }
        .back-link { display: inline-block; margin-bottom: 20px; color: #3498db; text-decoration: none; }
        .back-link:hover { text-decoration: underline; }
        /* ★★★ ヘッダーを中央揃えに ★★★ */
        th {
            background-color: #f2f2f2;
            text-align: center;
        }
        .col-product-name { width: 34%; } .col-department { width: 15%; text-align: center; } .col-quantity { width: 10%; } .col-price { width: 13%; } .col-subtotal { width: 14%; } .col-cost { width: 13%; } .col-cost-subtotal { width: 14%; }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">&laquo; 得意先一覧に戻る</a>
        <h1>納品金額計算</h1>
        <div id="customerProductsContainer">
            <h2><span id="selectedCustomerName"></span> 様の納品履歴商品</h2>
            <p>数量を入力すると、下の伝票に自動で反映されます。</p>
            <table id="customerProductsTable">
                <thead>
                    <tr>
                        <th class="col-product-name">商品名</th><th class="col-department">部門</th><th class="col-price">単価</th><th class="col-quantity">数量</th>
                    </tr>
                </thead>
                <tbody><tr><td colspan="4">データを読み込んでいます...</td></tr></tbody>
            </table>
        </div>
    </div>
    <div class="container">
        <h2><strong>伝票内容</strong></h2>
        <div id="invoiceContainer"></div>
    </div>

    <script>
        // ★★★ ここから修正 ★★★
        const MASTER_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRpGhiBjllLFan-dzUY5k9Bog2RKMGdcEph5E4itfZaOVQ1dEZQIqNM6_vGG5OsUyvwfeC4nDG-64aa/pub?gid=0&single=true&output=csv';

        async function fetchCsvAsJson(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok.');
                const csvText = await response.text();
                const lines = csvText.trim().split(/\r\n|\n/);
                const headers = lines[0].split(',');
                return lines.slice(1).map(line => {
                    const values = line.split(',');
                    return headers.reduce((obj, header, index) => {
                        const value = values[index];
                        obj[header] = isNaN(value) || value === '' ? value : parseFloat(value);
                        return obj;
                    }, {});
                });
            } catch (error) {
                console.error('Error fetching or parsing CSV:', error);
                return [];
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const selectedCustomerNameEl = document.getElementById('selectedCustomerName');
            const customerProductsTableBody = document.querySelector('#customerProductsTable tbody');
            const invoiceContainer = document.getElementById('invoiceContainer');

            const params = new URLSearchParams(window.location.search);
            const customerId = parseInt(params.get('customerId'), 10);

            if (!customerId) {
                document.querySelector('body').innerHTML = `<div class="container"><h1>エラー</h1><p>有効な得意先が選択されていません。</p><a href="customers.html">得意先一覧に戻ってください。</a></div>`;
                return;
            }

            const masterData = await fetchCsvAsJson(MASTER_DATA_URL);
            
            // この得意先に関連するデータだけをフィルタリング
            const customerSpecificData = masterData.filter(row => row.customerId === customerId);

            if (customerSpecificData.length === 0) {
                 document.querySelector('body').innerHTML = `<div class="container"><h1>エラー</h1><p>指定された得意先のデータが見つかりません。</p><a href="customers.html">得意先一覧に戻ってください。</a></div>`;
                return;
            }

            const customerName = customerSpecificData[0].customerName;
            displayCustomerProducts(customerName, customerSpecificData);
            customerProductsTableBody.addEventListener('input', () => generateInvoices(customerSpecificData));

            function displayCustomerProducts(customerName, products) {
                selectedCustomerNameEl.textContent = customerName;
                customerProductsTableBody.innerHTML = '';

                if (products.length > 0) {
                    products.forEach(product => {
                        const row = document.createElement('tr');
                        // データ属性としてproductIdだけでなく、行全体の情報を保持すると後で楽
                        row.dataset.productId = product.productId;
                        row.innerHTML = `<td>${product.productName}</td><td class="col-department">${product.departmentName}</td><td class="price-cell">${product.price.toLocaleString()}</td><td><input type="number" class="quantity-input" min="0" placeholder="0"></td>`;
                        customerProductsTableBody.appendChild(row);
                    });
                } else {
                    customerProductsTableBody.innerHTML = '<tr><td colspan="4">この得意先に登録されている商品はありません。</td></tr>';
                }
                generateInvoices(products);
            }

            function generateInvoices(products) {
                const allItems = collectAllItems(products);
                const groupedByDept = groupItemsByDepartment(allItems);
                renderInvoices(groupedByDept);
            }

            function collectAllItems(products) {
                const items = [];
                customerProductsTableBody.querySelectorAll('tr[data-product-id]').forEach(row => {
                    const quantity = parseFloat(row.querySelector('.quantity-input').value);
                    if (quantity > 0) {
                        const productId = parseInt(row.dataset.productId, 10);
                        const productData = products.find(p => p.productId === productId);
                        if (productData) {
                            items.push({ ...productData, quantity });
                        }
                    }
                });
                return items;
            }

            function groupItemsByDepartment(items) {
                const grouped = {};
                items.forEach(item => {
                    const deptId = item.departmentId;
                    if (!grouped[deptId]) {
                        grouped[deptId] = { name: item.departmentName, items: [] };
                    }
                    grouped[deptId].items.push(item);
                });
                return grouped;
            }

            function renderInvoices(groupedData) {
                invoiceContainer.innerHTML = '';
                for (const deptId in groupedData) {
                    const dept = groupedData[deptId];
                    const departmentHeader = document.createElement('h3');
                    departmentHeader.textContent = dept.name;
                    invoiceContainer.appendChild(departmentHeader);
                    const table = document.createElement('table');
                    table.innerHTML = `<thead><tr><th class="col-product-name">品名</th><th class="col-quantity">数量</th><th class="col-price">売単価</th><th class="col-subtotal">売価金額</th><th class="col-cost">原単価</th><th class="col-cost-subtotal">原価金額</th></tr></thead>`;
                    const tbody = document.createElement('tbody');
                    let itemCounter = 0;
                    let runningSubtotal = 0;
                    let runningCostSubtotal = 0;
                    dept.items.forEach((item, index) => {
                        itemCounter++;
                        const itemSubtotal = item.quantity * item.price;
                        const costSubtotal = item.quantity * (item.cost || 0);
                        runningSubtotal += itemSubtotal;
                        runningCostSubtotal += costSubtotal;
                        const row = document.createElement('tr');
                        // ★★★ 原価が未設定(0または空)の場合は空欄にする ★★★
                        const displayCost = item.cost ? item.cost.toLocaleString() : '';
                        const displayCostSubtotal = item.cost ? costSubtotal.toLocaleString() : '';

                        row.innerHTML = `<td>${item.productName}</td><td class="price-cell">${item.quantity}</td><td class="price-cell">${item.price.toLocaleString()}</td><td class="subtotal">${itemSubtotal.toLocaleString()}</td><td class="price-cell">${displayCost}</td><td class="cost-subtotal">${displayCostSubtotal}</td>`;
                        tbody.appendChild(row);
                        const isLastItem = index === dept.items.length - 1;
                        if (itemCounter % 6 === 0 || isLastItem) {
                            // 6の倍数で、かつ最後の品目でない場合のみ「6品小計」とする
                            const label = (itemCounter % 6 === 0 && !isLastItem) ? '売価金額合計' : '売価金額合計';
                            const subtotalRow = document.createElement('tr');
                            subtotalRow.className = 'subtotal-row';
                            subtotalRow.innerHTML = `<td colspan="3" class="total-label">${label}</td><td class="total-value">${runningSubtotal.toLocaleString()}</td><td class="total-label">原価金額合計</td><td class="total-value">${runningCostSubtotal.toLocaleString()}</td>`;
                            tbody.appendChild(subtotalRow);
                            runningSubtotal = 0;
                            runningCostSubtotal = 0;
                        }
                    });
                    table.appendChild(tbody);
                    invoiceContainer.appendChild(table);
                }
            }
        });
        // ★★★ ここまで修正 ★★★
    </script>
</body>
</html>
